using System.Net.Http;
using System.Net.Http.Json;
using System.Windows;
using IcdControl.Models;
using Microsoft.Win32;
using System.IO;
using System.Text;

namespace IcdControl.Client
{
    public partial class MainWindow : Window
    {
        private HttpClient _http = new HttpClient { BaseAddress = new Uri("http://localhost:5273/") };
        private List<Icd> _icds = new List<Icd>();

        public MainWindow()
        {
            InitializeComponent();
        }

        private async void Login_Click(object sender, RoutedEventArgs e)
        {
            var res = await _http.PostAsJsonAsync("api/icd/login", new LoginRequest { Email = "a@a.com", Password = "123" });
            if (res.IsSuccessStatusCode) MessageBox.Show("מחובר לשרת!");
            else MessageBox.Show("שגיאת התחברות");
        }

        private async void Window_Loaded(object sender, RoutedEventArgs e)
        {
            await LoadIcds();
        }

        private async System.Threading.Tasks.Task LoadIcds()
        {
            try
            {
                _icds = await _http.GetFromJsonAsync<List<Icd>>("api/icd/list") ?? new List<Icd>();
                IcdGrid.ItemsSource = _icds;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Failed to load ICDs: {ex.Message}");
            }
        }

        private async void RefreshBtn_Click(object sender, RoutedEventArgs e)
        {
            await LoadIcds();
        }

        private void NewBtn_Click(object sender, RoutedEventArgs e)
        {
            var win = new NewIcdWindow();
            win.Owner = this;
            if (win.ShowDialog() == true)
            {
                // saved, refresh
                _ = LoadIcds();
            }
        }

        private void OpenBtn_Click(object sender, RoutedEventArgs e)
        {
            if (IcdGrid.SelectedItem is Icd selected)
            {
                var win = new IcdEditorWindow(selected.IcdId);
                win.Owner = this;
                win.ShowDialog();
            }
            else
            {
                MessageBox.Show("Select an ICD first.");
            }
        }

        private async void ExportBtn_Click(object sender, RoutedEventArgs e)
        {
            if (IcdGrid.SelectedItem is Icd selected)
            {
                try
                {
                    var res = await _http.GetAsync($"api/icd/{selected.IcdId}/export");
                    if (!res.IsSuccessStatusCode)
                    {
                        MessageBox.Show($"Export failed: {(int)res.StatusCode} {res.ReasonPhrase}");
                        return;
                    }
                    var content = await res.Content.ReadAsStringAsync();
                    var dlg = new SaveFileDialog { Filter = "C Header|*.h", FileName = MakeSafeFileName(selected.Name) + ".h" };
                    if (dlg.ShowDialog() == true)
                    {
                        File.WriteAllText(dlg.FileName, content, Encoding.UTF8);
                        MessageBox.Show("Export saved.");
                    }
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Export failed: {ex.Message}");
                }
            }
            else
            {
                MessageBox.Show("Select an ICD first.");
            }
        }

        private string MakeSafeFileName(string name)
        {
            var sb = new StringBuilder();
            foreach (var ch in name ?? string.Empty)
            {
                if (char.IsLetterOrDigit(ch) || ch == '_' || ch == '-') sb.Append(ch);
                else sb.Append('_');
            }
            return sb.ToString();
        }
    }
}